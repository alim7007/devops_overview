// for project:  https://github.com/alim7007/budget-app-deploy/
// ğŸ”— Checkout â†’ gets your code.

// ğŸ³ Build â†’ only runs if FORCE_BUILD is true.

// ğŸ˜ Database Setup â†’ starts Postgres only.

// ğŸ—„ï¸ DB Migrate â†’ runs db:create and db:migrate inside your web container.

// ğŸ” Lint: RuboCop â†’ checks Ruby style.

// ğŸ¨ Lint: Stylelint â†’ uses node:18 so you donâ€™t fight Node versions.

// ğŸ§ª Test: RSpec â†’ runs your tests.

pipeline {
  agent any

  environment {
    POSTGRES_USER = 'blog-app'
    POSTGRES_PASSWORD = 'securepass'
    POSTGRES_DB = 'budgetdb'
  }

  parameters {
    booleanParam(name: 'FORCE_BUILD', defaultValue: false, description: 'Force rebuild web image?')
  }

  stages {

    stage('Checkout') {
      steps {
        echo "ğŸ”— Checking out repo..."
        git branch: 'main',
            url: 'https://github.com/alim7007/budget-app-deploy/'
      }
    }

    stage('Build') {
      when {
        expression { params.FORCE_BUILD == true }
      }
      steps {
        echo "ğŸ³ Building fresh web image..."
        sh "docker-compose -f docker-compose.yaml build"
      }
    }

    stage('Database Setup') {
      steps {
        script {
          echo "ğŸ˜ Starting database container..."
          sh "docker-compose -f docker-compose.yaml up -d db"
          sh "sleep 5"
        }
      }
    }

    stage('DB Migrate') {
      steps {
        script {
          echo "ğŸ—„ï¸ Running Rails DB tasks..."
          sh "docker-compose -f docker-compose.yaml run --rm web bundle exec rails db:create db:migrate"
        }
      }
    }

    stage('Lint: RuboCop') {
      steps {
        script {
          echo "ğŸ” Running RuboCop..."
          sh "docker-compose -f docker-compose.yaml run --rm web bundle exec rubocop"
        }
      }
    }

    stage('Lint: Stylelint') {
      steps {
        script {
          echo "ğŸ¨ Running Stylelint in Node 18..."
          sh "docker run --rm -v \$PWD:/app -w /app node:18 npx stylelint \"**/*.{css,scss}\""
        }
      }
    }

    stage('Test: RSpec') {
      steps {
        script {
          echo "ğŸ§ª Running RSpec..."
          sh "docker-compose -f docker-compose.yaml run --rm web bundle exec rspec"
        }
      }
    }

  }

  post {
    always {
      echo "ğŸ§¹ Cleaning up containers and workspace..."
      sh "docker-compose -f docker-compose.yaml down -v || true"
      cleanWs()
    }
  }
}
